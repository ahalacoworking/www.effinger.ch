{{ define "head_includes" }}
<!-- Needed so that prerendering is used by web crawlers. -->
<meta name="fragment" content="!">
{{ end }}

{{ define "main" }}
<!-- Page Wrap -->
<div class="page" id="top">

  <nav class="main-nav transparent stick-fixed">
    {{ partial "navigation.html" . }}
  </nav>

  <!-- Header -->
  <section class="small-section-header bg-gray-lighter">
    <div class="relative container align-left pt-80">

      <div class="row">

        <div class="col-md-8">
          <h1 class="hs-line-11 font-alt mb-0">Stream</h1>
          <!--
          <div class="hs-line-4 font-alt black mt-20 mt-xs-0">
            get in touch
          </div>
          -->
        </div>
      </div>

    </div>
  </section>
  <!-- End Header -->

  <section class="page-section page-section--small">
    <div class="stream-container" id="stream-container">

      <!-- streamEntry -->
      <!--<div class="streamEntry">
        <div class="streamEntry__column">
          <img class="streamEntry__image" src="http://via.placeholder.com/1000x800">
          <div class="streamEntry__textbox">
            <h3 class="streamEntry__text">Das ist ein Test</h3>
            <div class="streamEntry__authoring">
              <span class="streamEntry__name">Hans Wurst</span>
              <span class="streamEntry__time">12.55 Uhr</span>
            </div>
          </div>
          <div class="datebox">
            <span class="datebox__day">03</span>
            <span class="datebox__month">Nov</span>
            <span class="datebox__year">17</span>
          </div>
        </div>
      </div>-->
      <!-- End streamEntry -->
    </div>
    <div id="stream-loader" class="text-center mt-10">
      <i class="fa fa-spinner fa-spin fa-2x fa-fw"></i>
    </div>
    <div class="container container--stream">
      <button id="button-load-more" class="btn btn-medium btn-mod btn-border" style="display: none;">Mehr laden</button>
    </div>
  </section>
</div>
<!-- End Page Wrap -->
{{ end }}

{{ define "body_includes" }}
<!-- Fetch streams -->
<script src="/js/moment-with-locales.min.js"></script>
<script type="text/javascript">

  $(document).ready(function() {

    var StreamIndex = {
      DATE: 0,
      AUTHOR: 1,
      COMMENT: 2,
      IMAGE_URL: 3,
      IMAGE_WIDTH: 4,
      IMAGE_HEIGHT: 5,
    };

    // The batch of images that should be loaded.
    var LOAD_BATCH = 12;
    var currentPostId;


    // Loads from the specified amount of images.
    function loadPosts() {
      $("#stream-loader").show();
      $("#button-load-more").hide();

      // Do not go below row 1.
      var endPostId = Math.max(currentPostId - LOAD_BATCH + 1, 1);

      $.get("https://sheets.googleapis.com/v4/spreadsheets/1zdudRkT_1emT-ngS0aKWOZ15QN440OT7ULA_1hedeLM/values/Sheet1!" + currentPostId + ":" + endPostId + "?key=AIzaSyAcKsXpUFgllXtNsRJaOBz-0kBR2PkqC04", function( data ) {

        $("#stream-loader").hide();

        $.each(data.values.reverse(), function(i, item) {
          appendPost(item, currentPostId - i);
        });

        currentPostId = endPostId - 1;

        if (currentPostId >= 1) {
          $("#button-load-more").show();
        }
      });
    }

    // Loads a single post with current postId.
    function loadSinglePost() {
      $.get("https://sheets.googleapis.com/v4/spreadsheets/1zdudRkT_1emT-ngS0aKWOZ15QN440OT7ULA_1hedeLM/values/Sheet1!" + currentPostId + ":" + currentPostId + "?key=AIzaSyAcKsXpUFgllXtNsRJaOBz-0kBR2PkqC04", function( data ) {

        // Check if postId is valid.
        if (data.values) {
          appendPost(data.values[0], currentPostId, true);
        }
      });
    }

    // Appends the post to the stream.
    function appendPost(item, itemId, isSinglePage) {
      isSinglePage = isSinglePage || false; // default is not a single page item.

      var maxImageSize = 1000;
      var imageUrl = item[StreamIndex.IMAGE_URL].replace("upload/", "upload/w_" + maxImageSize + ",h_" + maxImageSize + ",c_limit/");

      var itemComment = item[StreamIndex.COMMENT];
      var itemAuthor = item[StreamIndex.AUTHOR];
      var itemDate = item[StreamIndex.DATE];


      $('#stream-container').append('\
      <div class="streamEntry" id="' + itemId + '">\
        <div class="streamEntry__column">\
          <img class="streamEntry__image" src="' +
          imageUrl + '">\
          <div class="streamEntry__textbox">\
            <h3 class="streamEntry__text">\
              ' + itemComment + '\
            </h3>\
            <div class="streamEntry__authoring">\
              <span class="streamEntry__name">\
                @' + itemAuthor + '\
              </span>\
              <span class="streamEntry__time">\
                ' + moment(itemDate).format("HH.mm") + ' Uhr\
              </span>\
              <span class="streamEntry__socialmedia">\
                <a target="_blank" href="https://www.facebook.com/sharer.php?u=https://www.effinger.ch/stream/' + itemId + '/"><i class="fa fa-facebook"></i></a>&nbsp;\
                <a target="_blank" href="https://twitter.com/intent/tweet?url=https://www.effinger.ch/stream/' + itemId + '/&amp;text=' + itemComment + '&amp;hashtags=effinger"><i class="fa fa-twitter"></i></a>\
              </span>\
            </div>\
          </div>\
          <div class="datebox">\
            <span class="datebox__day">\
              ' + moment(itemDate).format("DD") + '\
            </span>\
            <span class="datebox__month">\
              ' + moment(itemDate).format("MMM").slice(0, -1) + '\
            </span>\
            <span class="datebox__year">\
              ' + moment(itemDate).format("YY") + '\
            </span>\
          </div>\
        </div>\
      </div>');

      if (isSinglePage) {
        // We have only one element. It is a single image page.

        var originalImageWidth = item[StreamIndex.IMAGE_WIDTH];
        var originalImageHeight = item[StreamIndex.IMAGE_HEIGHT];

        // Calculate the actual image dimensions.
        var ratio = Math.min(maxImageSize / originalImageWidth, maxImageSize / originalImageHeight);
        var imageWidth = Math.round(originalImageWidth * ratio);
        var imageHeight = Math.round(originalImageHeight * ratio);

        // Set open graph meta data.
        // Note: This will only work if the server does prerendering.
        $('meta[property=og\\:image]').attr('content', imageUrl);
        $('meta[property=og\\:url]').attr('content', window.location);
        $('meta[property=og\\:description]').attr('content', itemComment);
        $('meta[name=description]').attr('content', itemComment);
        $('meta[property=og\\:image\\:width]').attr('content', imageWidth);
        $('meta[property=og\\:image\\:height]').attr('content', imageHeight);
      }
    }

    // Get the image id from url if available.
    var pathArray = window.location.pathname.split( '/' );

    // test for single post locally.
    // currentPostId = 2;
    // loadSinglePost();
    // $("#button-load-more").remove();

    if (pathArray.length > 2 && pathArray[2]) {
      // We have a row specified in the location hash.
      currentPostId = pathArray[2];
      loadSinglePost();

      $("#button-load-more").hide();

    } else {
      // Get the total number of posts.
      $.get("https://sheets.googleapis.com/v4/spreadsheets/1zdudRkT_1emT-ngS0aKWOZ15QN440OT7ULA_1hedeLM/values/Sheet1!L1?key=AIzaSyAcKsXpUFgllXtNsRJaOBz-0kBR2PkqC04", function( data ) {
        // Start with the last row.
        currentPostId = data.values[0][0];
        loadPosts();
      });
    }



    $("#button-load-more").click(function() {
      loadPosts();
    });

    moment.locale("de");


  });
</script>
{{ end }}
