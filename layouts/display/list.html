{{ define "main" }}
<div class="container">
  <div class="lds-grid" style="display:none;"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>

  <h1 class="title">Gäste heute</h1>
  
  <div class="content">
  </div>
</div>
{{ end }}

{{ define "body_includes" }}
<script type="text/javascript" src="/js/jquery-1.12.0.min.js"></script>
<script type="text/javascript" src="/js/moment-with-locales.min.js"></script>
<script>
  $(document).ready(function() {

    moment.locale("de");

    // Periodically update events.
    setInterval(function() {
      loadEvents();
    }, 20000);
    loadEvents();

    function loadEvents() {
      // Show loading indicator.
      $('.lds-grid').show();

      var startOfDay = moment().startOf('day');
      var endOfDay = moment().endOf('day');

      // Set title date of today.
      $('.title').html("Gäste heute &mdash; " + startOfDay.format('dd DD.MM.YYYY'));

      var calendarApiPath = '{{ .Site.Data.room_manager.apiUrl }}';
      var xhr = $.ajax({
        url: calendarApiPath,
        data: {
          calendarId: '{{ delimit .Params.calendarIds "," }}',
          start: startOfDay.toISOString(),
          end: endOfDay.toISOString()
        },
        dataType: "jsonp",
        success: function(data) {
          var events = [];

          for (var calendarName in data.results) {

            var calendarEvents = data.results[calendarName];

            var roomFloor = "";
            var roomName = "";
            
            var calendarNameElements = calendarName.split("-");
            if (calendarNameElements.length === 3) {
              roomFloor = calendarNameElements[1];
              roomName = calendarNameElements[2];
            }

            for (var i = 0; i < calendarEvents.length; i++) {
              var value = calendarEvents[i];
              var title = value.title;

              events.push({
                roomFloor: roomFloor,
                roomName: roomName,
                title: title,
                start: value.start,
                end: value.end,
              });
            }
          }

          // Sort by start time.
          events.sort(function(a, b) {
            if (a.start > b.start) {
              return 1; 
            } else {
              if (b.start > a.start) {
                return -1;
              } else {
                return 0;
              }
            }
          });

          // Display events in table if we have events.
          if (events.length > 0) {
            var tableContent = "<table class='table room-table'><tbody>";
            for (var i = 0; i < events.length; i++) {
              var event = events[i];
              
              var eventStart = moment(event.start);
              var eventEnd = moment(event.end);

              if (eventEnd.isBefore()) {
                tableContent += "<tr class='event-ended'>";
              } else {
                tableContent += "<tr>";
              }

              tableContent += "<td class='room-time'>" + eventStart.format('HH:mm') + " &ndash; ";
              tableContent += eventEnd.format('HH:mm') + "</td>";
              tableContent += "<td class='room-title'>" + event.title + "</td>";
              tableContent += "<td class='room-floor'>" + event.roomFloor + "</td>";
              tableContent += "<td class='room-name'>" + event.roomName + "</td>";
              tableContent += "</tr>";
            }
            tableContent += "</tbody></table>";
            
            $('.content').html(tableContent);
          } else {
            // Empty table.
            $('.content').html('Gibt nichts anzuzeigen heute...');
          }

          // Hide loading indicator.
          $('.lds-grid').hide();
        },
        error: function(err) {
          console.log(this.url);
          console.log("AJAX error in request: " + JSON.stringify(err, null, 2));
        },
        timeout: 12000 // Set timeout.
      });
    }

  });
</script>
{{ end }}
